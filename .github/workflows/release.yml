name: Build and Release

on:
  push:
    tags:
      - 'v*'

# Set permissions for the workflow
permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-apple-darwin
        
    - name: Install dependencies
      run: |
        brew install create-dmg
        brew install imagemagick
        
    - name: Build DMG Installer
      run: |
        cd metadata-generator
        chmod +x scripts/*.sh
        ./scripts/create-dmg-installer.sh
        
    - name: Create zip backup
      run: |
        cd metadata-generator
        ./scripts/build-app.sh
        zip -r MetadataGenerator-macOS.zip MetadataGenerator.app
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          metadata-generator/MetadataGenerator-Installer.dmg
          metadata-generator/MetadataGenerator-macOS.zip
        body: |
          ## MetadataGenerator ${{ github.ref_name }}
          
          ### What's New
          - Professional DMG installer with custom icon
          - Drag-and-drop installation experience
          - Optimized for macOS 10.15+
          
          ### Installation
          1. Download the DMG installer
          2. Double-click to mount
          3. Drag to Applications folder
          4. Launch from Applications
          
          ### System Requirements
          - macOS 10.15 (Catalina) or later
          - No additional dependencies required
          
          ### For Developers
          - Built with Rust and egui
          - Source code available in this repository
          - CLI version also included
          
          ### Release Notes
          This release includes a professional DMG installer with custom branding and improved user experience.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 